version: '3.8'

services:
  axon:
    build: .
    container_name: axon-trading
    restart: unless-stopped
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
    volumes:
      # Mount config file for live updates
      - ./axon.cfg.yml:/app/axon.cfg.yml:ro
      # Persist data and outputs
      - ./data:/app/data
      - ./outputs:/app/outputs
      - ./knowledge:/app/knowledge
    ports:
      - "8080:8080" # For future API
    healthcheck:
      test: [ "CMD", "python", "-c", "from src.battle_arena.core.resilience import get_system_status; s=get_system_status(); exit(0 if 'error' not in s else 1)" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Paper trading mode (safer for testing)
  axon-paper:
    build: .
    container_name: axon-paper
    restart: unless-stopped
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - AXON_MODE=paper
    volumes:
      - ./data:/app/data
      - ./outputs:/app/outputs
    command: [ "python", "-c", "from src.battle_arena.core.paper_trader import PaperTrader; p=PaperTrader(); print('Paper trader ready')" ]
    profiles:
      - paper
